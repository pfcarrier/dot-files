#!/usr/bin/env bash

if [[ -z "$1" ]] ; then
  echo "FATAL: args required.  You likely want to run"
  echo "       $0 apt-debian repos clean init"
  exit 1
fi

set -exo pipefail

for args in "$@" ; do
  case "${args}" in
    apt-termux)
      apt-get update
      apt-get install -y \
        vim \
        neovim \
        curl \
        golang \
        git \
        tmate \
        tmux \
        mosh \
        tree
      ;;
    apt-debian)
      sudo apt-get update
      sudo apt-get install -y \
        vim \
        curl \
        git \
        tmate \
        tmux \
        mosh \
        tree \
        keychain
      sudo apt-get install -t jessie-backports \
        golang \
        tmate
      ;;
    brew)
      brew install \
        coreutils \
        vim \
        neovim/neovim/neovim \
        curl \
        golang \
        git \
        tmate \
        tmux \
        mosh \
        tree
      ;;
    clean)
      rm -f \
        ~/.vimrc \
        ~/.config/nvim/init.vim \
        ~/.gitconfig \
        ~/.bash_profile \
        ~/work/bash-git-prompt/themes/p2.bgptheme
      ;;
    init)
      curl -fLo ~/.vim/autoload/plug.vim --create-dirs \
        https://raw.githubusercontent.com/junegunn/vim-plug/master/plug.vim
      curl -fLo ~/.local/share/nvim/site/autoload/plug.vim --create-dirs \
        https://raw.githubusercontent.com/junegunn/vim-plug/master/plug.vim
      mkdir -p ~/.config/nvim/
      ln -s ~/.vimrc ~/.config/nvim/init.vim
      ln -s ~/work/dot-files/vim/vimrc ~/.vimrc
      ln -s ~/work/dot-files/gitconfig ~/.gitconfig
      ln -s ~/work/dot-files/bash_profile ~/.bash_profile
      ln -s ~/work/dot-files/bash-git-prompt/p2.bgptheme ~/work/bash-git-prompt/themes/p2.bgptheme
      source ~/.bash_profile
      vim -c PlugInstall -c q -c q
      vim -c GoInstallBinaries -c q -c q
      if which nvim &>/dev/null ; then
        nvim -c PlugInstall -c q -c q
        nvim -c GoInstallBinaries -c q -c q
      fi
      #vim -E -c GoUpdateBinaries -c q -c q
      #nvim -E -c GoUpdateBinaries -c q -c q
      ;;
    linux)
      if [[ "$HOME" == *"termux"* ]] ; then
        exec bash $0 apt-termux repos clean init
      else
        exec bash $0 apt-debian repos clean init
      fi
      ;;
    macos)
      exec bash $0 brew repos clean init
      ;;
    repos)
      (
        mkdir -p ~/work
        cd ~/work
        [[ ! -e dot-files ]] && git clone git@github.com:pfcarrier/dot-files.git
        [[ ! -e bash-git-prompt ]] \
          && git clone git@github.com:magicmonty/bash-git-prompt.git
        true # prevent sub shell return code to be false from the last "if"
      )
      ;;
    *)
      echo "FATAL:  unknown option '$args'"
      exit 1
      ;;
  esac
done

echo "complete"
